## Что такое Docker-образ

Docker image — это шаблон только для чтения, который содержит всё необходимое для запуска контейнера:

* файловую систему (библиотеки, зависимости, бинарники, конфигурации);
* метаданные (точка входа, переменные окружения, порты и т. д.);
* ссылки на родительские слои (base image).

Образ можно рассматривать как снимок состояния системы — вроде минимальной операционной системы со всем необходимым для приложения.

---

## Из чего состоит образ

Образ состоит из нескольких слоёв (layers), которые накладываются друг на друга, формируя единую файловую систему.

Каждый слой — это:

* результат одной инструкции в Dockerfile (например, RUN, COPY, ADD);
* неизменяемый (immutable);
* может повторно использоваться другими образами.

Пример Dockerfile:

```dockerfile
FROM ubuntu:22.04
RUN apt-get update && apt-get install -y python3
COPY . /app
CMD ["python3", "/app/main.py"]
```

Это создаёт слои:

1. Базовый образ ubuntu:22.04
2. Слой после RUN apt-get ...
3. Слой после COPY . /app
4. Метаданные (CMD, ENV и т. п.)

---

## Как Docker хранит и использует образы

Физически Docker хранит образы и их слои в каталоге вроде `/var/lib/docker/` (зависит от драйвера хранения: overlay2, btrfs, zfs).

Каждый слой — это архив (обычно tar), содержащий разницу по сравнению с предыдущим слоем.

Когда запускается контейнер:

1. Docker берёт все слои образа (только для чтения).
2. Сверху добавляет слой записи (container layer), куда попадают изменения во время работы контейнера.
3. Все слои монтируются в единую объединённую файловую систему (UnionFS).

Контейнер видит единый каталог, но на самом деле это стек read-only слоёв и одного read-write слоя.

---

## Визуальная структура

```
Образ
┌─────────────────────────────┐
│ Layer 3: COPY . /app        │ <- ваше приложение
├─────────────────────────────┤
│ Layer 2: RUN apt-get ...    │ <- зависимости
├─────────────────────────────┤
│ Layer 1: FROM ubuntu:22.04  │ <- базовая ОС
└─────────────────────────────┘

Контейнер
┌─────────────────────────────┐
│ RW layer (изменения в runtime) │ <- создаётся при запуске
├─────────────────────────────┤
│ Слои образа (read-only)    │
└─────────────────────────────┘
```

---

## Кэширование слоёв

Docker кэширует каждый слой. Если часть Dockerfile не изменилась, соответствующие слои берутся из кэша. Это ускоряет сборку и уменьшает размер хранения.

---

## Абстрактно

За абстракцией Docker-образ — это:

* сериализованный снимок состояния файловой системы;
* набор описаний шагов (manifest.json, config.json);
* граф слоёв, связанных по хэшам (SHA256);
* объект, который можно переносить и воспроизводить в другом окружении (через registry, например Docker Hub).

---

## В Docker Registry

Когда образ пушится в реестр, Docker отправляет слои по отдельности. Если слой уже есть в реестре, он не пересылается.

---

Итоговая структура:

| Уровень     | Что происходит                                           |
| ----------- | -------------------------------------------------------- |
| Логический  | Образ — шаблон для контейнеров                           |
| Файловый    | Набор слоёв, представляющих изменения в файловой системе |
| Физический  | Архивы tar + JSON-манифесты                              |
| При запуске | Docker монтирует стек read-only слоёв + RW слой          |